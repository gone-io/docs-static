<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Goner和依赖注入 | Gone 文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/assets/img/logo.png">
    <script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ed9e5a48d8eeb5e6b55a0de9cb8f6486";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
if(location.pathname == '/my-github'){
    location.href='https://github.com/gone-io/gone'
}
</script>
    <meta name="description" content="Gone是一个轻量的，基于Golang的，依赖注入框架，集成了Gin、XOrm、Logrus等众多开源工具，用于提供便捷的Web开发。">
    <link rel="preload" href="/assets/css/0.styles.ef76fb7a.css" as="style"><link rel="preload" href="/assets/js/app.2acd4eb9.js" as="script"><link rel="preload" href="/assets/js/2.f18e2b4c.js" as="script"><link rel="preload" href="/assets/js/1.83b28654.js" as="script"><link rel="preload" href="/assets/js/25.24cbbbcb.js" as="script"><link rel="prefetch" href="/assets/js/10.0ee1033c.js"><link rel="prefetch" href="/assets/js/11.1b93f309.js"><link rel="prefetch" href="/assets/js/12.dfb21252.js"><link rel="prefetch" href="/assets/js/13.ba2e5946.js"><link rel="prefetch" href="/assets/js/14.dc48dc13.js"><link rel="prefetch" href="/assets/js/15.f5494b4f.js"><link rel="prefetch" href="/assets/js/16.0eb527a0.js"><link rel="prefetch" href="/assets/js/17.b17c6981.js"><link rel="prefetch" href="/assets/js/18.1208b728.js"><link rel="prefetch" href="/assets/js/19.99982a9d.js"><link rel="prefetch" href="/assets/js/20.a0fd51dd.js"><link rel="prefetch" href="/assets/js/21.fd8de9f3.js"><link rel="prefetch" href="/assets/js/22.5fdea428.js"><link rel="prefetch" href="/assets/js/23.f7691d82.js"><link rel="prefetch" href="/assets/js/24.7c3c0d31.js"><link rel="prefetch" href="/assets/js/26.fb8359d0.js"><link rel="prefetch" href="/assets/js/27.f64ac172.js"><link rel="prefetch" href="/assets/js/28.147c889a.js"><link rel="prefetch" href="/assets/js/29.dbd850a7.js"><link rel="prefetch" href="/assets/js/3.c0437673.js"><link rel="prefetch" href="/assets/js/30.baecc1e9.js"><link rel="prefetch" href="/assets/js/31.341ed0ef.js"><link rel="prefetch" href="/assets/js/32.c6d9753d.js"><link rel="prefetch" href="/assets/js/33.9e0e9f72.js"><link rel="prefetch" href="/assets/js/34.fada39fd.js"><link rel="prefetch" href="/assets/js/35.70505c96.js"><link rel="prefetch" href="/assets/js/36.64af0042.js"><link rel="prefetch" href="/assets/js/37.fd2080ec.js"><link rel="prefetch" href="/assets/js/38.b0974a03.js"><link rel="prefetch" href="/assets/js/39.1dcdeef9.js"><link rel="prefetch" href="/assets/js/4.29a103ea.js"><link rel="prefetch" href="/assets/js/40.527e265e.js"><link rel="prefetch" href="/assets/js/41.68ef0249.js"><link rel="prefetch" href="/assets/js/42.25ff645c.js"><link rel="prefetch" href="/assets/js/43.3ee054e7.js"><link rel="prefetch" href="/assets/js/44.8524cfde.js"><link rel="prefetch" href="/assets/js/45.97b2f9d2.js"><link rel="prefetch" href="/assets/js/46.76b7283f.js"><link rel="prefetch" href="/assets/js/47.60a63559.js"><link rel="prefetch" href="/assets/js/48.8fbbe616.js"><link rel="prefetch" href="/assets/js/49.cf3d7ecf.js"><link rel="prefetch" href="/assets/js/5.4fad613e.js"><link rel="prefetch" href="/assets/js/50.f965afa5.js"><link rel="prefetch" href="/assets/js/51.09a1be72.js"><link rel="prefetch" href="/assets/js/52.4bef3c38.js"><link rel="prefetch" href="/assets/js/53.855e2d0c.js"><link rel="prefetch" href="/assets/js/54.34561898.js"><link rel="prefetch" href="/assets/js/55.6b9900ca.js"><link rel="prefetch" href="/assets/js/56.301462a9.js"><link rel="prefetch" href="/assets/js/57.2e3de2ee.js"><link rel="prefetch" href="/assets/js/58.657a3431.js"><link rel="prefetch" href="/assets/js/59.9de64b25.js"><link rel="prefetch" href="/assets/js/6.43db7c1f.js"><link rel="prefetch" href="/assets/js/60.410bdef9.js"><link rel="prefetch" href="/assets/js/61.cca9baa4.js"><link rel="prefetch" href="/assets/js/62.42af55f9.js"><link rel="prefetch" href="/assets/js/63.ed133e63.js"><link rel="prefetch" href="/assets/js/64.50980d0c.js"><link rel="prefetch" href="/assets/js/7.94af19b6.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.cf079a49.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ef76fb7a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="Gone 文档" class="logo"> <span class="site-name can-hide">Gone 文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  介绍
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="快速开始" class="dropdown-title"><span class="title">快速开始</span> <span class="arrow down"></span></button> <button type="button" aria-label="快速开始" class="mobile-dropdown-title"><span class="title">快速开始</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/quick-start/simple.html" class="nav-link">
  一个简单的web项目
</a></li><li class="dropdown-item"><!----> <a href="/zh/quick-start/mysql.html" class="nav-link">
  Web+MySQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发指南" class="dropdown-title"><span class="title">开发指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发指南" class="mobile-dropdown-title"><span class="title">开发指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/core-concept.html" class="nav-link">
  核心概念
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/gone-and-inject.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Goner和依赖注入
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/goner-inject.html" class="nav-link">
  支持哪些方式注入？
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/inner-goner.html" class="nav-link">
  优雅使用内置Goners
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/config.html" class="nav-link">
  支持配置文件
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/xorm.html" class="nav-link">
  操作数据库
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/hooks.html" class="nav-link">
  Hook函数
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/logrus.html" class="nav-link">
  日志输出
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/tracer.html" class="nav-link">
  使用traceId追踪日志
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/auto-gen-priest.html" class="nav-link">
  自动生成Priest
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/redis.html" class="nav-link">
  分布式锁和分布式缓存
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/unit-test.html" class="nav-link">
  单元测试
</a></li></ul></div></div><div class="nav-item"><a href="/zh/references/" class="nav-link">
  References
</a></div><div class="nav-item"><a href="/zh/goners/" class="nav-link">
  Goners
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/gone-and-inject.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/guide/gone-and-inject.html" class="nav-link">
  English
</a></li></ul></div></div> <a href="https://github.com/gone-io/gone" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  介绍
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="快速开始" class="dropdown-title"><span class="title">快速开始</span> <span class="arrow down"></span></button> <button type="button" aria-label="快速开始" class="mobile-dropdown-title"><span class="title">快速开始</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/quick-start/simple.html" class="nav-link">
  一个简单的web项目
</a></li><li class="dropdown-item"><!----> <a href="/zh/quick-start/mysql.html" class="nav-link">
  Web+MySQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发指南" class="dropdown-title"><span class="title">开发指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发指南" class="mobile-dropdown-title"><span class="title">开发指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/core-concept.html" class="nav-link">
  核心概念
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/gone-and-inject.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Goner和依赖注入
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/goner-inject.html" class="nav-link">
  支持哪些方式注入？
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/inner-goner.html" class="nav-link">
  优雅使用内置Goners
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/config.html" class="nav-link">
  支持配置文件
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/xorm.html" class="nav-link">
  操作数据库
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/hooks.html" class="nav-link">
  Hook函数
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/logrus.html" class="nav-link">
  日志输出
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/tracer.html" class="nav-link">
  使用traceId追踪日志
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/auto-gen-priest.html" class="nav-link">
  自动生成Priest
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/redis.html" class="nav-link">
  分布式锁和分布式缓存
</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/unit-test.html" class="nav-link">
  单元测试
</a></li></ul></div></div><div class="nav-item"><a href="/zh/references/" class="nav-link">
  References
</a></div><div class="nav-item"><a href="/zh/goners/" class="nav-link">
  Goners
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/gone-and-inject.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/guide/gone-and-inject.html" class="nav-link">
  English
</a></li></ul></div></div> <a href="https://github.com/gone-io/gone" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Goner和依赖注入</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/guide/gone-and-inject.html#goner和依赖注入" class="sidebar-link">Goner和依赖注入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/guide/gone-and-inject.html#goner的定义" class="sidebar-link">Goner的定义</a></li><li class="sidebar-sub-header"><a href="/zh/guide/gone-and-inject.html#在gone中是如何完成依赖注入的" class="sidebar-link">在Gone中是如何完成依赖注入的？</a></li><li class="sidebar-sub-header"><a href="/zh/guide/gone-and-inject.html#如何执行goner中的业务代码" class="sidebar-link">如何执行Goner中的业务代码？</a></li><li class="sidebar-sub-header"><a href="/zh/guide/gone-and-inject.html#gone命令-自动生成priest函数" class="sidebar-link">gone命令，自动生成Priest函数</a></li></ul></li><li><a href="/zh/guide/gone-and-inject.html#匿名注入与具名注入" class="sidebar-link">匿名注入与具名注入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/guide/gone-and-inject.html#具名埋葬" class="sidebar-link">具名埋葬</a></li></ul></li><li><a href="/zh/guide/gone-and-inject.html#指针注入、值注入-和-接口注入" class="sidebar-link">指针注入、值注入 和 接口注入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/guide/gone-and-inject.html#指针注入-vs-接口注入" class="sidebar-link">指针注入 vs 接口注入</a></li></ul></li><li><a href="/zh/guide/gone-and-inject.html#slice注入和-map注入" class="sidebar-link">Slice注入和 Map注入</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/zh/guide/gone-and-inject.html#私有属性注入" class="sidebar-link">私有属性注入</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/zh/guide/gone-and-inject.html#配置注入" class="sidebar-link">配置注入</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="goner和依赖注入"><a href="#goner和依赖注入" class="header-anchor">#</a> Goner和依赖注入</h2> <h3 id="goner的定义"><a href="#goner的定义" class="header-anchor">#</a> Goner的定义</h3> <p>在Gone应用中，所有的组件都被要求定义为Goner（就是“继承”了<code>gone.Flag</code>的结构体，实际上golang中根本没有“集成”这个概念，它有的只有匿名嵌套）；如果Goner的某个属性标注了<code>gone:&quot;&quot;</code>标签，Gone框架将尝试自动装配该属性。下面是定义一个Goner的例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> example
<span class="token keyword">import</span> <span class="token string">&quot;github.com/gone-io/gone&quot;</span>
<span class="token keyword">type</span> AGoner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag
<span class="token punctuation">}</span>
</code></pre></div><p>在另一个Goner中注入上面定义的AGoner:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> example
<span class="token keyword">import</span> <span class="token string">&quot;github.com/gone-io/gone&quot;</span>
<span class="token keyword">type</span> BGoner <span class="token keyword">struct</span><span class="token punctuation">{</span>
    gone<span class="token punctuation">.</span>Flag
    A <span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//gone标签的作用在于告诉Gone，该属性需要被自动注入一个值</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中，注入的和被注入的结构体都要求是<code>Goner</code>（也就是匿名嵌套了<code>gone.Flag</code>的结构体），<code>BGoner</code>的<code>A</code>属性的<code>gone:&quot;*&quot;</code>标签的作用在于告诉框架：这个属性需要被注入一个值。</p> <h3 id="在gone中是如何完成依赖注入的"><a href="#在gone中是如何完成依赖注入的" class="header-anchor">#</a> 在Gone中是如何完成依赖注入的？</h3> <p>在Java Spring中，给class打上<code>@Component</code>、<code>@Service</code>等标注，Spring启动时会自动扫描到这些特殊的类，然后实例化他们并且给他们有特定标注的属性注入对应的值。</p> <p>Spring之所以能够实现这样的功能，Java有一个特性很关键，就是Java代码在编译成jar后，会保留所有class的字节码，哪怕是没有被<code>main</code>函数依赖的class代码；然而，在Golang中，编译后的代码会被裁剪，二进制文件中只会保留<code>main</code>函数依赖的相关代码。所以我们仅是定义Goner，在编译后我们会发现我们Goner代码全部被裁剪了。</p> <p>如何让我们的<strong>Goners</strong>不被裁剪掉呢？答案很简单，我们显式的将所有Goner加入到一个”仓库“中；在Gone中，这个仓库叫做<code>Cemetery</code>。<code>Goner</code>有“死者”的意思；<code>Cemetery</code>是墓地，用于埋葬（Bury）<code>Goner</code>。我们可以在程序启动时，将所有的<strong>Goner</strong>实例化后并加入到<strong>Cemetery</strong>中：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;example&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;github.com/gone-io/gone&quot;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>cemetery gone<span class="token punctuation">.</span>Cemetery<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        cemetery<span class="token punctuation">.</span><span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>example<span class="token punctuation">.</span>AGoner<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		cemetery<span class="token punctuation">.</span><span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>example<span class="token punctuation">.</span>BGoner<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，我们看到<code>gone.Run</code>可以接收形式如 <strong><code>func (cemetery gone.Cemetery) error</code></strong> 的函数；实际上这个函数，我们称之为 <strong>Priest</strong>，是牧师的意思，他专门负责将 <strong>Goner</strong> 埋葬到 墓地（<strong>Cemetery</strong>）。</p> <h3 id="如何执行goner中的业务代码"><a href="#如何执行goner中的业务代码" class="header-anchor">#</a> 如何执行<strong>Goner</strong>中的业务代码？</h3> <p>在Gone中，我们做了一个有趣的定义：Goner所有属性都被注入后，我们称这个Goner被复活了（<strong>Revive</strong>）。如果你查看Gone的源代码，你会发现管理复活Goner状态的组件叫<strong>Heaven</strong>（<strong>天堂</strong>），这里灵感来源于各宗教神话中人死后会上天堂的传说。</p> <p>为了执行<strong>Goner</strong>业务代码，我们可以在<strong>Goner</strong>上定义了方法 <strong><code>AfterRevive() gone.AfterReviveError</code></strong>，这个方法会在<strong>Goner</strong>被 <strong>Revive</strong> 后得到执行，并且我们将拥有该方法的 <strong>Goner</strong> 称之为 <strong>Prophet</strong>（也就是 <strong>先知</strong>）。实际上，一般情况我们只需要定义少量的先知来引导代码执行就可以了。</p> <p>下面是一个例子；代码可以在<a href="https://github.com/gone-io/gone/blob/main/example/after-revive/main.go" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>找到：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;github.com/gone-io/gone&quot;</span>
<span class="token keyword">type</span> Adder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Adder<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2 <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> a1 <span class="token operator">+</span> a2
<span class="token punctuation">}</span>
<span class="token keyword">type</span> Computer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag
	adder Adder <span class="token string">`gone:&quot;*&quot;`</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">Compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I want to compute!&quot;</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1000 add 2000 is&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>adder<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// AfterRevive 复活后执行的函数</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">AfterRevive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gone<span class="token punctuation">.</span>AfterReviveError <span class="token punctuation">{</span>
	<span class="token comment">// boot</span>
	c<span class="token punctuation">.</span><span class="token function">Compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>cemetery gone<span class="token punctuation">.</span>Cemetery<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		cemetery<span class="token punctuation">.</span><span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Computer<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		cemetery<span class="token punctuation">.</span><span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Adder<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行上面代码，将得到结果：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Revive github.com/gone-io/gone/heaven
Revive github.com/gone-io/gone/cemetery
Revive main/Computer
Revive main/Adder
I want to compute<span class="token operator">!</span>
<span class="token number">1000</span> <span class="token function">add</span> <span class="token number">2000</span> is <span class="token number">3000</span>
</code></pre></div><h3 id="gone命令-自动生成priest函数"><a href="#gone命令-自动生成priest函数" class="header-anchor">#</a> gone命令，自动生成<code>Priest</code>函数</h3> <p>实际上，前面已经讲完了Gone框架的核心功能；然而由于Golang本身的问题，我们无法做到像Spring那么方便，需要手动把所有 <strong><code>Goner</code></strong> 加入（<strong><code>Bury</code></strong>）到 <strong><code>Cemetery</code></strong>。为了让Gone使用起来更方便，我们编写了一个辅助工具来自动生成 <strong><code>Priest</code></strong> 函数。下面介绍如何在一个项目中使用这个辅助工具。</p> <blockquote><p>完整代码可以在<a href="https://github.com/gone-io/gone/blob/main/example/gen-code" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>找到</p></blockquote> <h4 id="_1-安装辅助工具-gone"><a href="#_1-安装辅助工具-gone" class="header-anchor">#</a> 1. 安装辅助工具: gone</h4> <p>辅助工具和Gone框架同名，也叫gone，可以使用<code>go install</code>进行安装，如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>go <span class="token function">install</span> github.com/gone-io/gone/tools/gone@latest
</code></pre></div><p>gone 命令的使用可以参考：<a href="https://goner.fun/zh/references/gone-tool.html" target="_blank" rel="noopener noreferrer">gone辅助工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_2-创建一个名为gen-code的新项目"><a href="#_2-创建一个名为gen-code的新项目" class="header-anchor">#</a> 2. 创建一个名为<code>gen-code</code>的新项目</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> gen-code
<span class="token builtin class-name">cd</span> gen-code
go mod init gen-code
</code></pre></div><h4 id="_3-创建goner"><a href="#_3-创建goner" class="header-anchor">#</a> 3. 创建Goner</h4> <p>文件名：goner.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;github.com/gone-io/gone&quot;</span>
<span class="token comment">//go:gone</span>
<span class="token keyword">func</span> <span class="token function">NewAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gone<span class="token punctuation">.</span>Goner <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Adder<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//go:gone</span>
<span class="token keyword">func</span> <span class="token function">NewComputer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gone<span class="token punctuation">.</span>Goner <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Computer<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> Adder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Adder<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2 <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> a1 <span class="token operator">+</span> a2
<span class="token punctuation">}</span>
<span class="token keyword">type</span> Computer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag
	adder Adder <span class="token string">`gone:&quot;*&quot;`</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">Compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I want to compute!&quot;</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1000 add 2000 is&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>adder<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// AfterRevive 复活后执行的函数</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">AfterRevive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gone<span class="token punctuation">.</span>AfterReviveError <span class="token punctuation">{</span>
	<span class="token comment">// boot</span>
	c<span class="token punctuation">.</span><span class="token function">Compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面代码中，请注意我们添加了两个工厂函数 <code>NewAdder() gone.Goner</code> 和 <code>func NewComputer() gone.Goner</code>，并且在函数前做了一个特殊的注释：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//go:gone</span>
</code></pre></div><p>请不要删除这个注释，这个注释的作用是告诉辅助工具如何生成代码的。</p> <h4 id="_4-使用辅助工具"><a href="#_4-使用辅助工具" class="header-anchor">#</a> 4. 使用辅助工具</h4> <p>请在<code>gen-code</code>目录下执行下面命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>gone priest <span class="token parameter variable">-s</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-p</span> main <span class="token parameter variable">-f</span> Priest <span class="token parameter variable">-o</span> priest.go
</code></pre></div><p>这个命令的含义是，扫描当前目录生成一个 <strong>牧师</strong> 函数，它的函数名为 <code>Priest</code>，所在的包名为<code>main</code>，代码放到名为<code>priest.go</code>的文件中。
代码执行完后，会在当前目录中生成一个文件<code>priest.go</code>，它的内容如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Code generated by gone; DO NOT EDIT.</span>
<span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;github.com/gone-io/gone&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">Priest</span><span class="token punctuation">(</span>cemetery gone<span class="token punctuation">.</span>Cemetery<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    cemetery<span class="token punctuation">.</span><span class="token function">Bury</span><span class="token punctuation">(</span><span class="token function">NewAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cemetery<span class="token punctuation">.</span><span class="token function">Bury</span><span class="token punctuation">(</span><span class="token function">NewComputer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-添加main函数"><a href="#_5-添加main函数" class="header-anchor">#</a> 5. 添加<code>main</code>函数</h4> <p>文件名：main.go</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;github.com/gone-io/gone&quot;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>Priest<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，我们就完成了整个小的Gone程序，它的文件结构如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">.</span>
├── go.mod
├── go.sum
├── goner.go   <span class="token comment">#  goner的定义</span>
├── main.go
└── priest.go  <span class="token comment"># 生成的代码</span>
</code></pre></div><p>可以通过命令<code>go run .</code>来执行，程序将输出如下内容：</p> <div class="language-code extra-class"><pre class="language-text"><code>Revive github.com/gone-io/gone/heaven
Revive github.com/gone-io/gone/cemetery
Revive main/Adder
Revive main/Computer
I want to compute!
1000 add 2000 is 3000
</code></pre></div><h2 id="匿名注入与具名注入"><a href="#匿名注入与具名注入" class="header-anchor">#</a> 匿名注入与具名注入</h2> <p>在前面的篇章中，我们所有的例子实际上都是按类型的匿名注入；匿名注入时，如果存在多个同类型的<strong>Goner</strong>，被注入只会是其中一个，通常是最先被复活的那个。在Gone中，是支持按名字注入的（也就是<strong>具名注入</strong>）。</p> <p>首先，<strong><code>Cemetery.Bury</code></strong> 函数的完整定义是这样的 <strong><code>Bury(Goner, ...GonerId) Cemetery</code></strong>，这样的定义有两层考虑：</p> <ul><li><ol><li>用于支持<strong>具名埋葬</strong>，第二个参数是可选的，允许传入一个字符串作为<strong>Goner</strong>的<strong>ID</strong>（<strong>GonerId</strong>）；</li></ol></li> <li><ol start="2"><li>使Bury函数支持链式调用。</li></ol></li></ul> <h3 id="具名埋葬"><a href="#具名埋葬" class="header-anchor">#</a> 具名埋葬</h3> <p>实现<strong>具名埋葬</strong>，我们的代码可以这样写：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Priest Responsible for putting Goners that need to be used into the framework</span>
<span class="token keyword">func</span> <span class="token function">Priest</span><span class="token punctuation">(</span>cemetery gone<span class="token punctuation">.</span>Cemetery<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	cemetery<span class="token punctuation">.</span>
		<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AGoner<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Injected Goner1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;A1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">//埋葬第一个AGoner，ID=A1</span>
		<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AGoner<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Injected Goner2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;A2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">//埋葬第二个AGoner，ID=A2</span>
		<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>BGoner<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外也可以这样写，这样写的好处是将Goner的构造和埋葬进行解耦：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// NewA1 构造A1 AGoner</span>
<span class="token keyword">func</span> <span class="token function">NewA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gone<span class="token punctuation">.</span>Goner<span class="token punctuation">,</span> gone<span class="token punctuation">.</span>GonerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>AGoner<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Injected Goner1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;A1&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">// NewA2 构造A2 AGoner</span>
<span class="token keyword">func</span> <span class="token function">NewA2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gone<span class="token punctuation">.</span>Goner<span class="token punctuation">,</span> gone<span class="token punctuation">.</span>GonerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>AGoner<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Injected Goner2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;A2&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Priest Responsible for putting Goners that need to be used into the framework</span>
<span class="token keyword">func</span> <span class="token function">Priest</span><span class="token punctuation">(</span>cemetery gone<span class="token punctuation">.</span>Cemetery<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	cemetery<span class="token punctuation">.</span>
		<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token function">NewA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token function">NewA2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>BGoner<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后，就是结构体的具名注入，举个例子就能立刻明白：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> BGoner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag         <span class="token comment">//tell the framework that this struct is a Goner</span>
	a         <span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//匿名注入一个AGoner</span>
	a1        <span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;A1&quot;`</span> <span class="token comment">//具名注入A1</span>
	a2        <span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;A2&quot;`</span> <span class="token comment">//具名注入A2</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意：上面代码，结构体属性后的标签：</p> <ul><li><code>gone:&quot;*&quot;</code>是按类型的<strong>匿名注入</strong>；</li> <li><code>gone:&quot;A1&quot;</code>是注入<code>ID=A1</code>的AGoner的<strong>具名注入</strong>。</li></ul> <p>就是说，<code>gone</code>标签的值如果是<code>*</code>就是匿名注入；如果不是<code>*</code>，标签值就是要注入Goner的名字，也就是具名注入；当然，因为go是强类型的，所以无论 匿名注入 还是 具名注入 的 <strong>Goner</strong> 都必须是类型兼容的，否则注入失败。</p> <h2 id="指针注入、值注入-和-接口注入"><a href="#指针注入、值注入-和-接口注入" class="header-anchor">#</a> 指针注入、值注入 和 接口注入</h2> <p>如果被注入结构体的属性是一个指针，那么这个注入就是 <strong>指针注入</strong>；<strong>值注入</strong> 和<strong>接口注入</strong> 的定义也是类似的。让我们来举个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> AGoner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag <span class="token comment">//tell the framework that this struct is a Goner</span>
	Name      <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>AGoner<span class="token punctuation">)</span> <span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I am the AGoner, My name is&quot;</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> Speaker <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> BGoner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag         <span class="token comment">//tell the framework that this struct is a Goner</span>
	a0         <span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;*&quot;`</span>  <span class="token comment">//匿名注入一个AGoner; 指针注入</span>
	a1        <span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;A1&quot;`</span> <span class="token comment">//具名注入A1； 指针注入</span>
	a2 AGoner  <span class="token string">`gone:&quot;A1&quot;`</span> <span class="token comment">// 值注入</span>
	a3 Speaker <span class="token string">`gone:&quot;A2&quot;`</span> <span class="token comment">// 接口注入</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码中，<code>BGoner.a0</code> 和 <code>BGoner.a1</code> 是 <strong>指针注入</strong>；<code>BGoner.a2</code>是值注入；<code>BGoner.a3</code>是 <strong>接口注入</strong>。</p> <p><strong>需要特别提醒：</strong>“在go语言中，<strong>值类型</strong> 的赋值和传参都是传递的拷贝”，这意味着我们如果使用<strong>值注入</strong>时，实际上产生了一个新的“对象”，并且新旧对象只有在“传递那一刻”是相等，他们在内存中是独立的；这可能导致一些不符合“直觉”的结果，举个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> BGoner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag
	a1 AGoner  <span class="token string">`gone:&quot;A1&quot;`</span> <span class="token comment">// 值注入</span>
	a2 AGoner  <span class="token string">`gone:&quot;A1&quot;`</span> <span class="token comment">// 值注入</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>BGoner<span class="token punctuation">)</span> <span class="token function">AfterRevive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gone<span class="token punctuation">.</span>AfterReviveError <span class="token punctuation">{</span>
	g<span class="token punctuation">.</span>a1<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;dapeng&quot;</span>
	g<span class="token punctuation">.</span>a2<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;wang&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;a1 is eq a2: %v&quot;</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>a1 <span class="token operator">==</span> g<span class="token punctuation">.</span>a2<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，<code>BGoner.a1</code> 和 <code>BGoner.a2</code> 都被注入了 同一个 Goner（<code>A1</code> ），但是因为是<strong>值注入</strong>，注入的过程中框架实际能做的只有将 <code>A1</code> Goner 的值拷贝给了 <code>BGoner.a1</code> 和 <code>BGoner.a2</code>；<code>BGoner.a1</code> 和 <code>BGoner.a2</code>被注入后，就和<code>A1</code>没有了任何联系，<code>BGoner.a1</code> 和 <code>BGoner.a2</code>之间也没有联系，内存中也会有三份<code>AGoner</code>类型的空间占用；<code>fmt.代码Printf(&quot;a1 is eq a2: %v&quot;, g.a1 == g.a2)</code>打印的结果也会是 <code>false</code>。</p> <blockquote><p>考虑到<strong>Gone</strong>作为基础框架更多意义只是提供可能性，所以我们保留了 <code>值注入</code> 功能；而<strong>大多数情况下，我们推荐使用 <code>指针注入</code> 和 <code>接口注入</code></strong>。</p></blockquote> <h3 id="指针注入-vs-接口注入"><a href="#指针注入-vs-接口注入" class="header-anchor">#</a> 指针注入 vs 接口注入</h3> <p>在Goner的Bury过程中，要求传递的是一个引用，即<code>Cemetery.Bury</code>方法的第一个参数必须是引用类型。指针注入和接口注入都可以将 <strong>Bury</strong> 的引用传递给结构体的属性。<strong>指针注入</strong>，简单直观，类型间一一对应，没有什么过多需要讲解的。接口（interface）做为go语言中最精华的设计之一，语言设计之初目的就在于 <strong>业务使用方和业务实现逻辑的解耦</strong>，让接口的使用方不用关注实现的细节。接口的另一个作用是解除<strong>循环依赖</strong>，如果两个模块间存在循环引用并且他们位于不同的包中；这样会导致package的循环依赖，在go语言中是禁止这样的行为的，编译阶段会失败。我们可以如下使用接口来解出package间的循环依赖。</p> <p>循环依赖：<br> <img src="data:image/png;base64,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" alt="循环依赖"></p> <p>使用接口解除循环依赖：<br> <img src="/assets/img/image7.ca08b1e7.png" alt="使用接口解除循环依赖"></p> <p>使用接口能够隐藏业务逻辑的实现细节，能够有效的降低模块间的耦合，也更好的遵守“开放封闭”原则；因此，我们推荐使用 <strong>接口注入</strong>。但是万事没有绝对，引入接口一定会增加额外的成本，所以我们还是支持了 <strong>指针注入</strong>。</p> <h2 id="slice注入和-map注入"><a href="#slice注入和-map注入" class="header-anchor">#</a> Slice注入和 Map注入</h2> <p>Gone 支持对<code>Slice</code>和<code>Map</code>进行注入，即支持如下写法的：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> BGoner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag
	aSlice1 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//被注入的属性为Goner指针Slice</span>
	aSlice2 <span class="token punctuation">[</span><span class="token punctuation">]</span>AGoner  <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//被注入的属性为Goner值Slice</span>
	aMap1 <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//被注入的属性为Goner指针的map</span>
	aMap2 <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>AGoner  <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//被注入的属性为Goner值的map</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>注入的规则如下：</strong></p> <ul><li><ol><li>Slice 和 Map 的元素类型可以是 Goner指针类型 和 Goner的值类型，也可以是一个接口；</li></ol></li> <li><ol start="2"><li>Gone会将所有类型兼容的Goner注入到Slice 和 Map；</li></ol></li> <li><ol start="3"><li>Map key的类型只能是string；</li></ol></li> <li><ol start="4"><li>Map key的值为被注入Goner的GonerId，埋葬时没有指定GonerId的匿名Goner，Gone会自动生成一个Id。</li></ol></li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>不推荐使用值作为Slice和Map的类型。</p></div> <p>下面是完整的例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;github.com/gone-io/gone&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">type</span> AGoner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag <span class="token comment">//tell the framework that this struct is a Goner</span>
	Name      <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>AGoner<span class="token punctuation">)</span> <span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;I am the AGoner, My name is: %s&quot;</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> BGoner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span>Flag
	aSlice1 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//被注入的属性为Goner指针Slice</span>
	aSlice2 <span class="token punctuation">[</span><span class="token punctuation">]</span>AGoner  <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//被注入的属性为Goner值Slice</span>
	aMap1 <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>AGoner <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//被注入的属性为Goner指针的map</span>
	aMap2 <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>AGoner  <span class="token string">`gone:&quot;*&quot;`</span> <span class="token comment">//被注入的属性为Goner值的map</span>
<span class="token punctuation">}</span>
<span class="token comment">// AfterRevive executed After the Goner is revived; After `gone.Run`, gone framework detects the AfterRevive function on goners and runs it.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>BGoner<span class="token punctuation">)</span> <span class="token function">AfterRevive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gone<span class="token punctuation">.</span>AfterReviveError <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> g<span class="token punctuation">.</span>aSlice1 <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;aSlice1:%s\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> g<span class="token punctuation">.</span>aSlice2 <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;aSlice2:%s\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> g<span class="token punctuation">.</span>aMap1 <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;aMap1[%s]:%s\n&quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> g<span class="token punctuation">.</span>aMap2 <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;aMap2[%s]:%s\n&quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">Say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// NewA1 构造A1 AGoner</span>
<span class="token keyword">func</span> <span class="token function">NewA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gone<span class="token punctuation">.</span>Goner<span class="token punctuation">,</span> gone<span class="token punctuation">.</span>GonerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>AGoner<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Injected Goner1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;A1&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">// NewA2 构造A2 AGoner</span>
<span class="token keyword">func</span> <span class="token function">NewA2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gone<span class="token punctuation">.</span>Goner<span class="token punctuation">,</span> gone<span class="token punctuation">.</span>GonerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>AGoner<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Injected Goner2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;A2&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gone<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>cemetery gone<span class="token punctuation">.</span>Cemetery<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		cemetery<span class="token punctuation">.</span>
			<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token function">NewA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AGoner<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Anonymous&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token function">NewA2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">Bury</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>BGoner<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>例子执行的结果如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Revive github.com/gone-io/gone/heaven
Revive github.com/gone-io/gone/cemetery
Revive main/AGoner
Revive main/AGoner
Revive main/AGoner
Revive main/BGoner
aSlice1:I am the AGoner, My name is: Injected Goner1
aSlice1:I am the AGoner, My name is: Anonymous
aSlice1:I am the AGoner, My name is: Injected Goner2
aSlice2:I am the AGoner, My name is: Injected Goner1
aSlice2:I am the AGoner, My name is: Anonymous
aSlice2:I am the AGoner, My name is: Injected Goner2
aMap1<span class="token punctuation">[</span>A1<span class="token punctuation">]</span>:I am the AGoner, My name is: Injected Goner1
aMap1<span class="token punctuation">[</span>main/AGoner<span class="token comment">#1374393662624]:I am the AGoner, My name is: Anonymous</span>
aMap1<span class="token punctuation">[</span>A2<span class="token punctuation">]</span>:I am the AGoner, My name is: Injected Goner2
aMap2<span class="token punctuation">[</span>A2<span class="token punctuation">]</span>:I am the AGoner, My name is: Injected Goner2
aMap2<span class="token punctuation">[</span>A1<span class="token punctuation">]</span>:I am the AGoner, My name is: Injected Goner1
aMap2<span class="token punctuation">[</span>main/AGoner<span class="token comment">#1374393662624]:I am the AGoner, My name is: Anonymous</span>
</code></pre></div><h2 id="私有属性注入"><a href="#私有属性注入" class="header-anchor">#</a> 私有属性注入</h2> <p>根据“开发封闭”原则，模块依赖的属性应该是私有的，Gone支持对结构体的私有变量注入。</p> <h2 id="配置注入"><a href="#配置注入" class="header-anchor">#</a> <a href="/zh/guide/guide/config.html">配置注入</a></h2></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zh/guide/core-concept.html" class="prev">
        Gone的核心概念
      </a></span> <span class="next"><a href="/zh/guide/goner-inject.html">
        Gone支持哪些方式注入？
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2acd4eb9.js" defer></script><script src="/assets/js/2.f18e2b4c.js" defer></script><script src="/assets/js/1.83b28654.js" defer></script><script src="/assets/js/25.24cbbbcb.js" defer></script>
  </body>
</html>
